"""–ò–≥—Ä–∞ –Ω–∞–π–¥–∏ –ø–∞—Ä—É.

–ü–µ—Ä–µ–¥ –≤–∞–º–∏ –±—É–¥–µ—Ç –ø–æ–ª–µ 4 –Ω–∞ 4 –∫–ª–µ—Ç–∫–∏.
–í–∞—à–∞ –∑–∞–¥–∞—á–∞ –Ω–∞–π—Ç–∏ –Ω–∞ —ç—Ç–æ–ø –ø–æ–ª–µ –ø–∞—Ä—ã –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π –≤–∫—É—Å–Ω–æ—Å—Ç–µ–π.
–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∑–∞–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ, —á—Ç–æ–±—ã –ø–æ–∫–∑–∞–∞—Ç—å –∫–∞–∫–∞—è —Ç–∞–º —Å–ø—Ä—è—Ç–∞–Ω–∞ –≤–∫—É—Å–Ω–æ—Å—Ç—å.
–¢–µ–ø–µ—Ä—å —Å–¥–µ–ª–∞–π—Ç–µ —Ç–∞–∫ –∂–µ —Å –µ—â—ë –æ–¥–Ω–∏–º –ø–æ–ª–µ–º.
–ï—Å–ª–∏ –≤–∫—É—Å–Ω–æ—Å—Ç–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç - –≤—ã –Ω–∞—à–ª–∏ –ø–∞—Ä—É.
–ï—Å–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–ª–∏, —Ç–æ –ø–æ–ª—è —Å–Ω–æ–≤–∞ –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è.

–î–æ–≤–æ–ª—å–Ω–æ –ø—Ä–æ—Å—Ç–∞—è –∏–≥—Ä–∞, –∫–æ—Ç–æ—Ä–∞—è —Ä–∞–∑–≤–∏–≤–∞–µ—Ç –ø–∞–º—è—Ç—å.


–ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç
-------------

- /pair - –ù–∞—á—Ç–∞—å –∏–≥—Ä—É –Ω–∞–π–¥–∏ –ø–∞—Ä—É

Version: v0.2
Author: Milinuri Nirvalen
"""

from random import shuffle

import arc
import hikari
import miru

# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
# =====================

plugin = arc.GatewayPlugin("Find pair")

# –ü–µ—Ä–µ—á–∏—Å–ª—è–µ–º –≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –≤–∫—É—Å–Ω–æ—Å—Ç–µ–π
# –ü–æ—Å–∫–æ–ª—å–∫—É –≤ –∫–æ–¥–µ –æ–Ω–∏ –±—É–¥—É—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã –∫–∞–∫ —á–∏—Å–ª–æ –æ—Ç 0 –¥–æ 8
# –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏ —Ç–∞–∫ –º—ã —Å–º–æ–∂–µ–º —Å–¥–µ–ª–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç–∏–ª–µ–π –¥–ª—è –∏–≥—Ä—ã
_PAIRS = [
    "üçå", "üçì", "üçá", "üçû", "ü•ê", "üç´", "üç¶","‚òï",
]


# –ö–ª–∞—Å—Å—ã –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –∏–≥—Ä–æ–≤—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤
# =====================================

class GameButton(miru.Button):
    """–ü–æ–ª–µ —Å–æ –≤–∫—É—Å–Ω–æ—Å—Ç—å—é.

    –î–∞–Ω–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π –ø–æ–ª–µ, –≤ –∫–æ–æ—Ç—Ä–æ–º —Å–ø—Ä—è—Ç–∞–Ω–∞ –≤–∫—É—Å–Ω–æ—Å—Ç—å.
    –ö–∞–∫ —Ç–æ–ª—å–∫–æ –≤—ã –Ω–∞–∂–∏–º–∞–µ—Ç–µ –Ω–∞ –ø–æ–ª–µ, —Ç–æ –æ–Ω–æ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –æ—Ç–∫—Ä—ã—Ç–º –∏
    –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ –≤ –Ω—ë–º –Ω–∞—Ö–æ–¥–∏—Ç—Å—è.
    –ï—Å–ª–∏ –ø–æ—Å–ª–µ—ç —Ç–æ–≥–æ –Ω–∞–π—Ç–∏ –¥–ª—è –Ω–µ–≥–æ –ø–∞—Ä—É, —Ç–æ –¥–∞–Ω–Ω–æ–µ –ø–æ–ª–µ —Å—Ç–∞–Ω–µ—Ç
    –ø–æ–º–µ—á–µ–Ω–æ –∫–∞–∫ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω–æ–µ –∏ –Ω–µ –±—É–¥–µ—Ç –∑–∞–∫—Ä—ã—Ç–æ.
    –ò–Ω–∞—á–µ, —Å–ª–µ–¥—É—é—â–∏–º —Ö–æ–¥–æ–º –ø–æ–ª–µ –≤–Ω–æ–≤—å –∑–∞–∫—Ä–æ–µ—Ç—Å—è.

    :param pair: –ö–∞–∫—É—é –ø–∞—Ä—É –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω–æ–µ –ø–æ–ª–µ (0-8).
    :type pair: int
    :param row: –ù–≤ –∫–∞–∫–æ–º —Ä—è–¥—É –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –¥–∞–Ω–Ω–∞—è –∫–Ω–æ–ø–∫–∞ (0-3).
    :type row: int
    """

    def __init__(self, pair: int, row: int) -> None:
        super().__init__(
            label="‚¨õ",
            style=hikari.ButtonStyle.SECONDARY,
            row=row
        )
        self.pair = pair

    async def callback(self, ctx: miru.ViewContext):
        """–î–µ–π—Å—Ç–≤–∏–µ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É.

        –î–ª—è –Ω–∞—á–∞–ª–∞ –¥–∞–Ω–Ω–∞—è –∏–≥—Ä–∞ –Ω–µ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤.
        –¢–∞–∫ —á—Ç–æ —Ç—É—Ç –Ω–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ —Ç–æ, –∫—Ç–æ –Ω–∞–∂–∞–ª –∫–Ω–æ–ø–∫–∏ –∏ –º–æ–∂–µ—Ç –ª–∏ –æ–Ω
        —ç—Ç–æ —Å–¥–µ–ª–∞—Ç—å.
        –ü–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –ø–æ–ª–µ, –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –º–µ—Ç–æ–¥ –¥–ª—è –µ–≥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è.
        –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, –Ω–µ –∑–∞–∫–æ–Ω—á–∏–ª–∞—Å—å –ª–∏ –∏–≥—Ä–∞.
        –ï—Å–ª–∏ –∏–≥—Ä–∞ –µ—â—ë –∏–¥—ë—Ç, –æ–±–Ω–æ–≤—è–ª–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞.
        –í –∏–Ω–æ–º —Å–ª—É—á–∞–µ –æ—Ç–ø—Ä–∞–≤–ª—è–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º –æ–∫–æ–Ω—á–∞–Ω–∏–∏ –∏–≥—Ä—ã.

        :param ctx: –ö–æ–Ω—Ç–µ–∫—Å—Ç –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏, –∫—Ç–æ –Ω–∞–∂–∞–ª, –≤ –∫–∞–∫–æ–º —á–∞—Ç–µ.
        :type ctx: miru.ViewContext
        """
        self.view.open_pair(self)
        game_over = self.view.is_game_over()
        if game_over:
            await ctx.edit_response(
                embed=self.view.end_game_message(),
                components=self.view
            )
            self.view.stop()
        else:
            await ctx.edit_response(
                embed=self.view.game_status(),
                components=self.view
            )

    def set_open(self) -> None:
        """–ü–æ–º–µ—á–∞–µ—Ç –¥–∞–Ω–Ω—É—é –∫–Ω–æ–ø–∫—É –∫–∞–∫ –æ—Ç–∫—Ä—ã—Ç—É—é."""
        self.disabled = True
        self.style = hikari.ButtonStyle.PRIMARY
        self.label = _PAIRS[self.pair]

    def set_close(self) -> None:
        """–ü–æ–º–µ—á–∞–µ—Ç –∫–Ω–æ–ø–∫–∞ –∫–∞–∫ –∑–∞–∫—Ä—ã—Ç—É—é, —Å–∫—Ä—ã–≤–∞—è –µ—ë —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ."""
        self.disabled = False
        self.style = hikari.ButtonStyle.SECONDARY
        self.label = "‚¨õ"

    def set_completed(self) -> None:
        """–ü–æ–º–µ—á–∞–µ—Ç –∫–Ω–æ–ø–∫—É –∫–∞–∫ —É—Å–ø–µ—à–Ω–æ –Ω–∞–π–¥–µ–Ω–Ω—É—é –ø–∞—Ä—É –¥–ª—è –Ω–µ—ë."""
        self.disabled = True
        self.style = hikari.ButtonStyle.SUCCESS
        self.label = _PAIRS[self.pair]


class PairView(miru.View):
    """–ü—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π –∏–≥—Ä–æ–≤–æ–µ –ø–æ–µ–ª –¥–ª—è –∏–≥—Ä—ã –Ω–∞–π–¥–∏ –ø–∞—Ä—É.

    –£ –≤–∞—Å –µ—Å—Ç—å 4 –Ω–∞ 4 –ø–æ–ª—è.
    –í –∫–∞–∂–¥–æ–º –∏–∑ –Ω–∏—Ö —Å–ø—Ä–∞—Ç—è–Ω–∞ –≤–∫—É—Å–Ω–æ—Ç—å.
    –í–∞—à–∞ –∑–∞–¥–∞—á–∞ –æ—Ç–∫—Ä—ã—Ç—å –≤—Å–µ –ø–æ–ª—è, –Ω–∞–π–¥—è –ø–∞—Ä—ã –≤—Å–µ–º –≤–∫—É—Å–Ω–æ—Å—Ç—è–º.
    """

    def __init__(self):
        super().__init__()

        self._board = []
        self.first_open: GameButton | None = None
        self.secons_open: GameButton | None = None
        self.pair_left = 0

        self.new_game()

    def new_game(self) -> None:
        """–ù–∞–∏—á–∏–Ω–∞–µ—Ç –Ω–æ–≤—É—é –∏–≥—Ä—É.

        –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —Å—Ç–∞—Ä–æ–π –∏–≥—Ä—ã, —Ä–∞—Å–∫–ª–∞–¥—ã–≤–∞–µ—Ç –≤–∫—É—Å–Ω–æ—Å—Ç–∏ –≤ —Å–ª—É—á–∞–Ω—ã—Ö
        –º–µ—Å—Ç–∞—Ö.
        """
        self._board.clear()
        self.first_open = None
        self.secons_open = None
        self.pair_left = 8

        for x in range(8):
            self._board.append(x)
            self._board.append(x)
        shuffle(self._board)

        for i, pair in enumerate(self._board):
            row = i // 4
            self.add_item(GameButton(pair, row=row))

    def open_pair(self, button: GameButton) -> None:
        """–û—Ç–∫—Ä—ã–≤–∞–µ—Ç –Ω–∞–∂–∞—Ç—É—é –∫–ª–µ—Ç–∫—É.

        –ê–ª–≥–æ—Ä–∏—Ç–º –æ—Ç–∫—Ä—ã—Ç–∏—è –∫–ª–µ—Ç–æ–∫ —Å–ª–µ–¥—É—é—â–∏–π:
        - –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–∞—è –∫–ª–µ—Ç–∫–∞ –≤ –ø–∞—Ä–µ - –æ—Ç–∫—Ä—ã–≤–∞–µ–º –µ—ë.
        - –ï—Å–ª–∏ —ç—Ç–æ –≤—Ç–æ—Ä–∞—è, —Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç –ª–∏ –æ–Ω–∞ —Å –ø–µ—Ä–≤–æ–π.
            - –ï—Å–ª–∏ —Å–æ–≤–ø–∞–ª–∞, —Ç–æ –ø–æ–º–µ—á–∞–µ–º –∫–∞–∫ –Ω–∞–π–¥–µ–Ω–Ω—É—é –ø–∞—Ä—É.
            - –ï—Å–ª–∏ –Ω–µ—Ç, —Ç–æ –ø—Ä–æ—Å—Ç–æ –æ—Ç–∫—Ä—ã–≤–∞–µ–º.
        - –ï—Å–ª–∏ –¥–≤–µ —Ä–∞–∑–Ω—ã–µ –∫–ª–µ—Ç–∫–∏ —Ä–∞–Ω–µ–µ –±—ã–ª–∏ –æ—Ç–∫—Ä—ã—Ç—ã, —Ç–æ –∑–∞–∫—Ä—ã–≤–∞–µ–º –∏—Ö.

        :param button: –ö–Ω–æ–ø–∫–∞, –Ω–∞ –∫–æ—Ç–æ—Ä—É—é –Ω–∞–∂–∞–ª–∏ —á—Ç–±—ã –æ—Ç–∫—Ä—ã—Ç—å –∫–ª–µ—Ç–∫—É.
        :type button: GameButton
        """
        if self.first_open is not None and self.secons_open is not None:
            self.first_open.set_close()
            self.first_open = None

            self.secons_open.set_close()
            self.secons_open = None

        if self.first_open is None:
            self.first_open = button
            button.set_open()

        elif self.secons_open is None:
            if self.first_open.pair == button.pair:
                self.first_open.set_completed()
                self.first_open = None
                button.set_completed()
                self.pair_left -= 1
            else:
                button.set_open()
                self.secons_open = button

    def is_game_over(self) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å –ª–∏ –∏–≥—Ä–∞.

        –ò–≥—Ä–∞ —Å—á–∏—Ç–∞–µ—Ç—Å—è –∑–∞–≤–µ—Ä—à—ë–Ω–Ω–æ–π, –∫–æ–≥–¥–∞ –Ω–∞–π–¥–µ–Ω—ã –≤—Å–µ –ø–∞—Ä—ã.
        """
        return self.pair_left <= 0

    def end_game_message(self) -> hikari.Embed:
        """–°–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∏–≥—Ä—ã.

        :return: –°–æ–æ–±—â–µ–Ω–∏–µ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –∏–≥—Ä—ã.
        :rtype: hikari.Embed
        """
        return hikari.Embed(
            title="‚òï –ù–∞–π–¥–∏ –ø–∞—Ä—É / –∏–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞",
            description="–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º, –≤—ã —É—Å–ø–µ—à–æ –Ω–∞—à–ª–∏ –≤—Å–µ –ø–∞—Ä—ã",
            color=hikari.colors.Color(0x8ff0a4)
        )

    def game_status(self) -> hikari.Embed:
        """–°–æ–æ–±—â–µ–Ω–∏–µ —Å —Ç–µ–∫—É—â–∏–º —Å—Ç–∞—Ç—É—Å–æ–º –∏–≥—Ä—ã.

        –°–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–±–æ–ª—å—à–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏–≥—Ä—ã —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏, –∞ —Ç–∞–∫–∂–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç
        –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –ø–∞—Ä, –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏–≥—Ä—ã.

        :return: –°–æ–æ–±—â–µ–Ω–∏–µ —Å —Ç–µ–∫—É—â–∏–º —Å—Ç–∞—Ç—É—Å–æ–º –∏–≥—Ä—ã.
        :rtype: hikari.Embed
        """
        return hikari.Embed(
            title="‚òï –ù–∞–π–¥–∏ –ø–∞—Ä—É",
            description=(
                "–í–∞—à–∞ –∑–∞–∞—á–∞ –Ω–∞–π—Ç–∏ –ø–∞—Ä—É –¥–ª—è –≤—Å–µ—Ö –≤–∫—É—Å–Ω–æ—Å—Ç–µ–π.\n"
                "- –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –ø–æ–ª–µ, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –µ–≥–æ.\n"
                "- –î–≤–∞ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –ø–æ–ª—è –æ–±—Ä–∞–∑—É—é—Ç –ø–∞—Ä—É.\n"
                "- –ù–µ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –ø–æ–ª—è –±—É–¥—É—Ç –∑–∞–∫—Ä—ã–≤–∞—Ç—å—Å—è."
            ),
            color=hikari.colors.Color(0x00ccff)
        ).add_field("–ü–∞—Ä –æ—Å—Ç–∞–ª–æ—Å—å", str(self.pair_left))


# –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥
# ==================

@plugin.include
@arc.slash_command("pair", description="–ò–≥—Ä–∞ –Ω–∞–π–¥–∏ –ø–∞—Ä—É.")
async def nya_handler(
    ctx: arc.GatewayContext,
    client: miru.Client = arc.inject()
) -> None:
    """–ù–∞—á–∏–Ω–∞–µ—Ç –Ω–æ—É–≤—é –∏–≥—Ä—É –ù–∞–π–¥–∏ –ø–∞—Ä—É."""
    view = PairView()
    await ctx.respond(view.game_status(), components=view)
    client.start_view(view)


# –ó–∞–≥—Ä—É–∑—á–∏–∫–∏ –∏ –≤—ã–≥—Ä—É–∑—á–∏–∫–∏ –ø–ª–∞–≥–∏–Ω–∞
# ===============================

@arc.loader
def loader(client: arc.GatewayClient) -> None:
    """–î–µ–π—Å—Ç–≤–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–ª–∞–≥–∏–Ω–∞."""
    client.add_plugin(plugin)

@arc.unloader
def unloader(client: arc.GatewayClient) -> None:
    """–î–µ–π—Å—Ç–≤–∏—è –ø—Ä–∏ –≤—ã–≥—Ä—É–∑–∫–µ –ø–ª–∞–≥–∏–Ω–∞."""
    client.remove_plugin(plugin)
